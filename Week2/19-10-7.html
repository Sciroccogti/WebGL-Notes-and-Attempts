<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>Week1 Attempt</title>
    <script id="vertex-shader" type="x-shader/x-vertex">
        attribute vec4 vPosition;
        
        void main()
        {
            gl_Position = vPosition;
            gl_PointSize = 2.0;
        }
    </script>

    <script id="fragment-shader" type="x-shader/x-fragment">
        precision mediump float;
        
        void main()
        {
            gl_FragColor = vec4( 1.0, 0.0, 0.0, 1.0 );
        }
    </script>
    <script type="text/javascript" src="../Common/webgl-utils.js"></script>
    <script type="text/javascript" src="../Common/initShaders.js"></script>
    <script type="text/javascript" src="../Common/MV.js"></script>
    <script>
        var gl;
        var points;
        var centre = vec2(0, 0);
        var interval;
        var time = 0;
        var ground;
        var points = [];
        var vertices = [];
        var isOK = true;

        window.onload = function init() {
            var canvas = document.getElementById("gl-canvas");

            gl = WebGLUtils.setupWebGL(canvas);
            if (!gl) { alert("WebGL isn't available"); }

            for (var i = 0; i < 360; i += 1) {
                var x = 80 * Math.cos(i * Math.PI / 180);
                var y = 180 + 80 * Math.sin(i * Math.PI / 180);
                points.push(vec2(x / 512.0, y / 512.0));
            }

            for (var i = 0; i < 360; i += 1) {
                var x = -60 + 30 * Math.cos(i * Math.PI / 180);
                var y = -160 + 80 * Math.sin(i * Math.PI / 180);
                points.push(vec2(x / 512.0, y / 512.0));
                x = 60 + 30 * Math.cos(i * Math.PI / 180);
                points.push(vec2(x / 512.0, y / 512.0));
            }

            for (var i = 0; i < 360; i += 1) {
                var x = 100 * Math.cos(i * Math.PI / 180);
                var y = 140 * Math.sin(i * Math.PI / 180);
                points.push(vec2(x / 512.0, y / 512.0));
            }

            for (var i = 0; i < 360; i += 1) {
                var x = -120 + 80 * Math.cos(i * Math.PI / 180);
                var y = 80 + 30 * Math.sin(i * Math.PI / 180);
                points.push(vec2(x / 512.0, y / 512.0));
                x = 120 + 80 * Math.cos(i * Math.PI / 180);
                points.push(vec2(x / 512.0, y / 512.0));
            }

            for (var i = 0; i < 360; i += 1) {
                var x = -80 + 30 * Math.cos(i * Math.PI / 180);
                var y = 250 + 30 * Math.sin(i * Math.PI / 180);
                points.push(vec2(x / 512.0, y / 512.0));
                x = 80 + 30 * Math.cos(i * Math.PI / 180);
                points.push(vec2(x / 512.0, y / 512.0));
            }
            //
            //  Configure WebGL
            gl.viewport(0, 0, canvas.width, canvas.height);
            gl.clearColor(1.0, 1.0, 1.0, 1.0);

            //  Load shaders and initialize attribute buffers

            var program = initShaders(gl, "vertex-shader", "fragment-shader");
            gl.useProgram(program);

            // Load the data into the GPU

            var bufferId = gl.createBuffer();
            gl.bindBuffer(gl.ARRAY_BUFFER, bufferId);

            // Associate out shader variables with our data buffer
            gl.vertexAttribPointer(vPosition, 2, gl.FLOAT, false, 0, 0);
            gl.enableVertexAttribArray(vPosition);

            var vPosition = gl.getAttribLocation(program, "vPosition");

            render();
        };


        function render() {
            vertices = [];

            points.forEach(function (value, index) {
                vertices.push(add(value, centre));
            });

            gl.bufferData(gl.ARRAY_BUFFER, flatten(vertices), gl.STATIC_DRAW);

            document.getElementById("xButton").onclick = function () {
                isOK = true;
            };

            document.getElementById("yButton").onclick = function () {
                isOK = false;
            };

            document.getElementById("zButton").onclick = function () {
                centre = vec2(0, 0);
                render();
            };

            gl.clear(gl.COLOR_BUFFER_BIT);
            gl.drawArrays(gl.points, 0, points.length);
        }

        window.addEventListener("keydown", function () {
            if (isOK == true) {
                switch (event.keyCode) {
                    case 37: // Left
                        centre = add(centre, vec2(-0.01, 0));
                        break;
                    case 38: // Up
                        centre = add(centre, vec2(0, 0.01));
                        break;
                    case 39: // Right
                        centre = add(centre, vec2(0.01, 0));
                        break;
                    case 40: // Down
                        centre = add(centre, vec2(0, -0.01));
                        break;
                    case 32: // Spacebar
                        ground = centre;
                        interval = setTimeout(jump(ground), 10); // 10ms
                    default:
                        break;
                }
            }
            render();
        });

        function jump() {
            time += 10;
            // x = 1/2 * a * t^2, vmax = (2 * a * x)^(0.5);
            var height = 0.02 * time - 0.5 * time * time * 0.0004;
            centre = add(ground, vec2(0, height));
            render();
            if (time >= 100) {
                clearTimeout(interval);
                time = 0;
            } else {
                requestAnimationFrame(jump);
            }
        }
    </script>

</head>
<!-- 发挥想象力，绘制一只动物（2D），要求：
A、	窗口背景白色，动物至少有两种颜色；
B、	可利用鼠标选取动物全部或某一部分，并拖动
C、	利用键盘实现前进、后退、跳跃等功能
D、	实现菜单功能
 -->

<body>
    <canvas id="gl-canvas" width="512" height="512"></canvas>
    <br />
    <button id="xButton">START</button>
    <button id="yButton">STOP</button>
    <button id="zButton">RESET</button>
</body>

</html>